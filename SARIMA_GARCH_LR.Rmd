---
title: "STA457 new"
author: "Lucas Wang"
date: "2025-04-01"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preprocessing Steps
```{r}
library(dplyr)
library(lubridate)
library(readr)
library(forecast)
library(tidyverse)
library(rugarch)
library(tibble)
library(ggplot2)


Daily_Price_CC <- read_csv("~/Desktop/STA457/STA457 Final Project/Daily Prices_ICCO.csv")
Daily_Price_CC$Date <- as.Date(Daily_Price_CC$Date, format = "%d/%m/%Y")
Daily_Price_CC$Price <- as.numeric(gsub(",", "", Daily_Price_CC$`ICCO daily price (US$/tonne)`))
Daily_Price_CC <- Daily_Price_CC %>% select(Date, Price) %>% arrange(Date)

ghana_Dayly_weather <- read_csv("~/Desktop/STA457/STA457 Final Project/Ghana_data.csv")
ghana_Dayly_weather$DATE <- as.Date(ghana_Dayly_weather$DATE)
ghana_Dayly_weather$PRCP <- ifelse(is.na(ghana_Dayly_weather$PRCP), 0, ghana_Dayly_weather$PRCP)
ghana_Dayly_weather <- ghana_Dayly_weather %>% 
  group_by(DATE) %>% 
  summarise(across(c(PRCP, TAVG, TMAX, TMIN), mean, na.rm = TRUE))

Weather_Price_CC <- left_join(
  Daily_Price_CC,
  ghana_Dayly_weather,
  by = c("Date" = "DATE")
) %>%
mutate(
  log_price = log(Price),
  diff_price = c(NA, diff(Price)),
  diff_log_price = c(NA, diff(log(Price)))
)%>%
  drop_na()

ggplot(Weather_Price_CC, aes(x = Date)) +
  geom_line(aes(y = Price), color = "darkgreen") +
  labs(title = "Daily Cocoa Prices", y = "Price", x = "Date") +
  theme_minimal()

ggplot(Weather_Price_CC, aes(x = Date)) +
  geom_line(aes(y = log_price), color = "steelblue") +
  labs(title = "Log Transformed Cocoa Prices", y = "Log(Price)", x = "Date") +
  theme_minimal()

ggplot(Weather_Price_CC, aes(x = Date)) +
  geom_line(aes(y = diff_log_price), color = "purple") +
  labs(title = "Log Transformed Cocoa Prices", y = "Log(Price)", x = "Date") +
  theme_minimal()

train_size <- floor(0.8 * nrow(Weather_Price_CC))
train_data <- Weather_Price_CC[1:train_size, ]
test_data <- Weather_Price_CC[(train_size + 1):nrow(Weather_Price_CC), ]
```

# ARIMA&SARIMA
```{r}
exter_var <- train_data %>% select(PRCP, TAVG, TMAX, TMIN)
model_arima <- auto.arima(train_data$diff_log_price, xreg = as.matrix(exter_var), seasonal = FALSE)
summary(model_arima)

model_sarima <- auto.arima(train_data$diff_log_price, xreg = as.matrix(exter_var), seasonal = TRUE)
summary(model_sarima)

checkresiduals(model_arima)

txreg <- as.matrix(test_data %>% select(PRCP, TAVG, TMAX, TMIN))
arimax_forecast <- forecast(model_arima, xreg = txreg, h = nrow(test_data))


last_log_price <- tail(train_data$log_price, 1)
forecast_log_price <- last_log_price + cumsum(arimax_forecast$mean)


forecast_price <- exp(forecast_log_price)


actual_price <- test_data$Price
arimax_price_accuracy <- accuracy(forecast_price, actual_price)

print("ARIMAX Price-Level Accuracy:")
print(arimax_price_accuracy)

forecast_dates <- test_data$Date
arimax_df <- tibble(
  Date = forecast_dates,
  Forecast = forecast_price  
)
actual_test_only <- tibble(
  Date = test_data$Date,
  Price = test_data$Price
)

arimax_df <- tibble(
  Date = test_data$Date,
  Forecast = forecast_price
)

ggplot() +
  geom_line(data = actual_test_only, aes(x = Date, y = Price, color = "Actual"), linewidth = 1.2) +
  geom_line(data = arimax_df, aes(x = Date, y = Forecast, color = "Predicted"),
            linewidth = 0.9, linetype = "dashed") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "orange")) +
  labs(
    title = "ARIMAX Forecast vs Actual (Test Set Only)",
    x = "Date", y = "Cocoa Price (USD/Tonne)",
    color = "Legend"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 10)
  )



```




# Garch
```{r}
train_returns <- diff(log(train_data$Price))
test_returns  <- diff(log(test_data$Price))
test_dates <- test_data$Date[-1]

garch_spec <- ugarchspec(
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  mean.model     = list(armaOrder = c(1, 0), include.mean = TRUE),
  distribution.model = "norm"
)

garch_fit <- ugarchfit(spec = garch_spec, data = train_returns)
garch_forecast <- ugarchforecast(garch_fit, n.ahead = length(test_returns))
predicted_returns <- as.numeric(fitted(garch_forecast))
last_train_price <- train_data$Price[nrow(train_data)]
forecast_prices <- last_train_price * exp(cumsum(predicted_returns))
garch_df <- tibble(
  Date = test_dates,
  Forecast = forecast_prices
)
garch_accuracy <- accuracy(forecast_prices, test_data$Price[-1])
print("GARCH Model Performance:")
print(garch_accuracy)

actual_test_only <- tibble(
  Date = test_data$Date[-1],  
  Price = test_data$Price[-1]
)

ggplot() +
  geom_line(data = actual_test_only, aes(x = Date, y = Price, color = "Actual"), linewidth = 1.2) +
  geom_line(data = garch_df, aes(x = Date, y = Forecast, color = "Predicted"),
            linewidth = 0.9, linetype = "dashed") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "orange")) +
  labs(
    title = "GARCH(1,1) Forecast vs Actual (Test Set Only)",
    y = "Cocoa Price (USD/Tonne)",
    x = "Date",
    color = "Legend"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 10)
  )
```
# Linear regression
```{r}


generate_lags <- function(data, lags = 1:4) {
  for (lag in lags) {
    data[[paste0("lag_", lag)]] <- dplyr::lag(data$log_price, lag)
  }
  return(data)
}

cc_data_lagged <- generate_lags(Weather_Price_CC) %>% drop_na()

lm_data <- cc_data_lagged %>%
  select(Date, log_price, starts_with("lag_"), PRCP, TAVG, TMAX, TMIN)

train_size <- floor(0.8 * nrow(lm_data))
train_lm <- lm_data[1:train_size, ]
test_lm  <- lm_data[(train_size + 1):nrow(lm_data), ]

lm_model <- lm(log_price ~ ., data = train_lm %>% select(-Date))

lm_pred_log   <- predict(lm_model, newdata = test_lm)
lm_pred_price <- exp(lm_pred_log)

actual_all <- tibble(
  Date = lm_data$Date,
  Price = exp(lm_data$log_price)
)

lm_results <- tibble(
  Date = test_lm$Date,
  Actual = exp(test_lm$log_price),
  Predicted = lm_pred_price
)

lm_accuracy <- accuracy(lm_results$Predicted, lm_results$Actual)
print("Linear Regression Accuracy (Test Set):")
print(lm_accuracy)

actual_test_only <- tibble(
  Date = test_lm$Date,
  Price = exp(test_lm$log_price)
)


ggplot() +
  geom_line(data = actual_test_only, aes(x = Date, y = Price, color = "Actual"), linewidth = 1.2) +
  geom_line(data = lm_results, aes(x = Date, y = Predicted, color = "Predicted"), 
            linewidth = 0.9, linetype = "dashed") +
  scale_color_manual(values = c("Actual" = "black", "Predicted" = "orange")) +
  labs(
    title = "Linear Regression Forecast vs Actual (Test Set Only)",
    y = "Cocoa Price (USD/Tonne)", x = "Date",
    color = "Legend"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 10)
  )
```


